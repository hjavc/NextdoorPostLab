<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Marketing Ops Console</title>
<style>
/* ========== RESET & BASE ========== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#181b23;--surface2:#1f2330;--surface3:#262a36;
  --border:#2a2e3b;--border-light:#363b4a;
  --text:#e8e9ed;--text-dim:#9499a8;--text-muted:#6b7085;
  --accent:#6c8cff;--accent-dim:#4a6ad4;--accent-bg:rgba(108,140,255,.08);
  --green:#4cd9a0;--green-bg:rgba(76,217,160,.08);
  --red:#f06868;--red-bg:rgba(240,104,104,.08);
  --orange:#f0a848;--orange-bg:rgba(240,168,72,.08);
  --yellow:#e8d44d;
  --radius:10px;--radius-sm:6px;
  --shadow:0 2px 12px rgba(0,0,0,.35);
  --transition:180ms ease;
}
html{font-size:15px;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}
input,textarea,select{font-family:inherit;font-size:inherit;color:var(--text);background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;width:100%;outline:none;transition:border var(--transition)}
input:focus,textarea:focus,select:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:80px}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239499a8' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
::placeholder{color:var(--text-muted)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ========== LAYOUT ========== */
.app{display:flex;flex-direction:column;min-height:100dvh}
.app-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border)}
.app-logo{font-size:1.1rem;font-weight:700;letter-spacing:-.02em;color:var(--text)}
.app-logo span{color:var(--accent);font-weight:400}
.app-content{flex:1;padding:16px;max-width:900px;width:100%;margin:0 auto;padding-bottom:80px}
.tab-bar{position:fixed;bottom:0;left:0;right:0;display:flex;background:var(--surface);border-top:1px solid var(--border);z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px 8px;font-size:.65rem;color:var(--text-muted);transition:color var(--transition);-webkit-user-select:none;user-select:none}
.tab-btn svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.tab-btn.active{color:var(--accent)}
.tab-btn:active{opacity:.7}

/* ========== COMPONENTS ========== */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px}
.card-title{font-size:.95rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card-title .badge{font-size:.7rem;font-weight:500;padding:2px 8px;border-radius:12px;background:var(--accent-bg);color:var(--accent)}
.form-group{margin-bottom:14px}
.form-group:last-child{margin-bottom:0}
.form-label{display:block;font-size:.78rem;font-weight:500;color:var(--text-dim);margin-bottom:6px;letter-spacing:.02em}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border-radius:var(--radius-sm);font-size:.85rem;font-weight:500;transition:all var(--transition);-webkit-user-select:none;user-select:none}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-dim)}
.btn-secondary{background:var(--surface3);color:var(--text-dim);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--border-light);color:var(--text)}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(240,104,104,.2)}
.btn-success{background:var(--green-bg);color:var(--green);border:1px solid rgba(76,217,160,.2)}
.btn-sm{padding:7px 12px;font-size:.78rem}
.btn-block{width:100%;justify-content:center}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}
.chip-group{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:6px 14px;border-radius:20px;font-size:.78rem;font-weight:500;background:var(--surface3);color:var(--text-dim);border:1px solid var(--border);cursor:pointer;transition:all var(--transition);-webkit-user-select:none;user-select:none}
.chip.active{background:var(--accent-bg);color:var(--accent);border-color:var(--accent)}
.chip:active{transform:scale(.96)}
.tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.68rem;font-weight:500;background:var(--surface3);color:var(--text-dim)}
.tag.green{background:var(--green-bg);color:var(--green)}
.tag.blue{background:var(--accent-bg);color:var(--accent)}
.tag.orange{background:var(--orange-bg);color:var(--orange)}
.tag.red{background:var(--red-bg);color:var(--red)}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}
.empty-state{text-align:center;padding:48px 20px;color:var(--text-muted)}
.empty-state svg{width:48px;height:48px;stroke:var(--border-light);margin-bottom:12px}
.empty-state p{font-size:.88rem;line-height:1.5}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120%);background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:10px 20px;font-size:.85rem;z-index:9999;box-shadow:var(--shadow);transition:transform 300ms ease;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity 200ms ease}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:600px;max-height:85dvh;overflow-y:auto;padding:20px;transform:translateY(100%);transition:transform 300ms ease}
.modal-overlay.show .modal{transform:translateY(0)}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.modal-header h3{font-size:1rem;font-weight:600}
.modal-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--surface3);color:var(--text-dim);font-size:1.2rem}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
.stat-card{background:var(--surface2);border-radius:var(--radius-sm);padding:14px;text-align:center}
.stat-value{font-size:1.4rem;font-weight:700;color:var(--text);line-height:1.2}
.stat-label{font-size:.7rem;color:var(--text-muted);margin-top:4px;text-transform:uppercase;letter-spacing:.04em}
.post-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color var(--transition)}
.post-card:active{border-color:var(--border-light)}
.post-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.post-card-title{font-size:.88rem;font-weight:600;color:var(--text)}
.post-card-meta{font-size:.72rem;color:var(--text-muted);display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.post-card-preview{font-size:.8rem;color:var(--text-dim);line-height:1.45;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.tab-content{display:none}
.tab-content.active{display:block}
.output-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;position:relative;white-space:pre-wrap;font-size:.84rem;line-height:1.55;color:var(--text-dim)}
.output-box .copy-btn{position:absolute;top:8px;right:8px;padding:4px 10px;font-size:.72rem;background:var(--surface3);border-radius:var(--radius-sm);color:var(--text-muted);border:1px solid var(--border)}
.output-label{font-size:.72rem;font-weight:600;color:var(--accent);margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em}
.reminder-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.reminder-item:last-child{border-bottom:none}
.reminder-check{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all var(--transition)}
.reminder-check.checked{background:var(--green);border-color:var(--green)}
.reminder-check.checked::after{content:'';display:block;width:6px;height:10px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);margin-top:-2px}
.winning-box{background:linear-gradient(135deg,rgba(108,140,255,.06),rgba(76,217,160,.06));border:1px solid rgba(108,140,255,.2);border-radius:var(--radius);padding:16px;margin-bottom:14px}
.winning-box h4{font-size:.88rem;font-weight:600;margin-bottom:10px;color:var(--accent)}
.winning-item{font-size:.82rem;color:var(--text-dim);padding:4px 0}
.winning-item strong{color:var(--text);font-weight:500}
.filter-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
.filter-bar select{width:auto;padding:7px 32px 7px 10px;font-size:.78rem}

@media(min-width:600px){
  .app-content{padding:24px}
  .modal{border-radius:var(--radius);margin:auto;max-height:80dvh}
  .modal-overlay{align-items:center}
  .modal .modal-inner{max-height:70dvh;overflow-y:auto}
}
</style>
</head>
<body>
<div class="app" id="app">
  <header class="app-header">
    <div class="app-logo">Marketing Ops <span>Console</span></div>
    <div style="font-size:.72rem;color:var(--text-muted)">Pressure Washing</div>
  </header>
  <main class="app-content" id="appContent"></main>
  <nav class="tab-bar" id="tabBar"></nav>
</div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="modalOverlay"><div class="modal" id="modal"></div></div>

<script>
/* ==========================================================================
   STATE MODEL
   ========================================================================== */
const DEFAULT_PROFILE = {
  tone: 'Friendly',
  bannedWords: ['limited time!!!','act now','hurry','best prices','lowest prices','cheap','guaranteed','#1','!!!','crazy deal','insane','unbeatable','blowout','don\'t miss out','once in a lifetime'],
  preferredPhrases: ['local owner-operator','fully insured','careful around landscaping','before & after available','free estimates','no pressure','happy to answer questions'],
  ctaStyles: ['DM me','Comment QUOTE','Text me','Call or text','Drop a comment'],
  proofPoints: {localOwner:true,insured:true,carefulPlants:true,beforeAfter:true,neighborhoodFocus:true,yearsExperience:false,googleReviews:false},
  serviceAreasGSO: ['Irving Park','Lindley Park','Hamilton Lakes','Friendly Acres','Starmount','Sunset Hills','Adams Farm','Westridge','New Irving Park'],
  serviceAreasTRI: ['Southpoint','Hope Valley','Woodcroft','Parkwood','Martin Luther King Jr Pkwy area','Research Triangle Park','Chapel Hill','Cary','Morrisville'],
};

const DEFAULT_STATE = {
  profile: JSON.parse(JSON.stringify(DEFAULT_PROFILE)),
  posts: [],
  results: {},
  nextId: 1,
};

let S = loadState();

/* ==========================================================================
   LOCALSTORAGE HELPERS
   ========================================================================== */
function loadState() {
  try {
    const raw = localStorage.getItem('moc_state');
    if (raw) {
      const parsed = JSON.parse(raw);
      // Ensure profile has all keys
      parsed.profile = Object.assign({}, DEFAULT_PROFILE, parsed.profile || {});
      if (!parsed.results) parsed.results = {};
      if (!parsed.nextId) parsed.nextId = (parsed.posts||[]).length + 1;
      return parsed;
    }
  } catch(e) { console.error('Load error', e); }
  return JSON.parse(JSON.stringify(DEFAULT_STATE));
}

function saveState() {
  try { localStorage.setItem('moc_state', JSON.stringify(S)); } catch(e) { console.error('Save error', e); }
}

function exportData() {
  const blob = new Blob([JSON.stringify(S, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'moc_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Data exported');
}

function importData(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.profile && Array.isArray(data.posts)) {
        S = data;
        S.profile = Object.assign({}, DEFAULT_PROFILE, S.profile);
        if (!S.results) S.results = {};
        if (!S.nextId) S.nextId = S.posts.length + 1;
        saveState();
        renderCurrentTab();
        toast('Data imported successfully');
      } else {
        toast('Invalid backup file');
      }
    } catch(err) { toast('Error reading file'); }
  };
  reader.readAsText(file);
}

/* ==========================================================================
   TOAST
   ========================================================================== */
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2200);
}

/* ==========================================================================
   MODAL
   ========================================================================== */
function openModal(html) {
  const overlay = document.getElementById('modalOverlay');
  document.getElementById('modal').innerHTML = html;
  requestAnimationFrame(() => overlay.classList.add('show'));
  overlay.onclick = function(e) { if (e.target === overlay) closeModal(); };
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

/* ==========================================================================
   NAVIGATION
   ========================================================================== */
const TABS = [
  {id:'builder', label:'Builder', icon:'<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>'},
  {id:'library', label:'Library', icon:'<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>'},
  {id:'results', label:'Results', icon:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>'},
  {id:'dashboard', label:'Dashboard', icon:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'},
  {id:'settings', label:'Settings', icon:'<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>'},
];

let currentTab = 'builder';

function renderTabBar() {
  const bar = document.getElementById('tabBar');
  bar.innerHTML = TABS.map(t =>
    `<button class="tab-btn${t.id===currentTab?' active':''}" data-tab="${t.id}">
      <svg viewBox="0 0 24 24">${t.icon}</svg>${t.label}</button>`
  ).join('');
  bar.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => { currentTab = btn.dataset.tab; render(); });
  });
}

function render() {
  renderTabBar();
  const c = document.getElementById('appContent');
  switch(currentTab) {
    case 'builder': renderBuilder(c); break;
    case 'library': renderLibrary(c); break;
    case 'results': renderResults(c); break;
    case 'dashboard': renderDashboard(c); break;
    case 'settings': renderSettings(c); break;
  }
}
function renderCurrentTab() { render(); }

/* ==========================================================================
   POST GENERATOR TEMPLATES
   ========================================================================== */
const HOOKS = {
  'Trust/Proof': [
    (ctx) => `Your neighbors in ${ctx.area} have been getting their ${ctx.serviceLower} taken care of this season. ${ctx.proofLine}`,
    (ctx) => `${ctx.proofLine} I've been working through ${ctx.area} lately and wanted to offer the same to your household.`,
    (ctx) => `Hi neighbors \u2014 ${ctx.ownerLine} Just finished a ${ctx.serviceLower} job nearby and have a few openings.`,
  ],
  'Seasonal problem': [
    (ctx) => `With ${ctx.season} here, ${ctx.serviceLower} buildup is one of those things that sneaks up on you. Now's a great time to take care of it.`,
    (ctx) => `${ctx.season} weather does a number on your ${ctx.serviceLower}. Before it gets worse, I can help.`,
    (ctx) => `If your ${ctx.serviceLower} is looking rough after this ${ctx.season.toLowerCase()}, you're not alone \u2014 it's the most common call I get this time of year.`,
  ],
  'Convenience': [
    (ctx) => `Getting your ${ctx.serviceLower} cleaned doesn't have to be a whole project. I handle everything and you don't even need to be home.`,
    (ctx) => `Quick and easy \u2014 I'll come out, clean your ${ctx.serviceLower}, and you'll see the difference the same day. No hassle.`,
    (ctx) => `Most ${ctx.serviceLower} jobs only take a couple hours. You go about your day, I'll take care of the rest.`,
  ],
  'Outcome': [
    (ctx) => `There's a real difference between a ${ctx.serviceLower} that's been cleaned and one that hasn't. Night and day, honestly.`,
    (ctx) => `Imagine pulling into your driveway and your ${ctx.serviceLower} actually looks the way it did when it was new. That's what I do.`,
    (ctx) => `A clean ${ctx.serviceLower} changes the whole look of your home. It's one of those things people notice right away.`,
  ],
};

const OFFER_LINES = {
  'Ballpark from photo': (ctx) => `Send me a photo and I'll get you a ballpark estimate \u2014 no commitment.`,
  'Bundle': (ctx) => `I also do bundle pricing if you want to knock out a couple things at once (${ctx.serviceLower} + another surface).`,
  'Starting-at': (ctx) => `${ctx.service} cleaning typically starts around a very reasonable price point. I'll give you an exact number after I see the space.`,
  'Seasonal reminder': (ctx) => `${ctx.season} is the best time to get this done before things really set in.`,
  'Availability': (ctx) => `I have a few openings this week if you want to get on the schedule.`,
};

const CTA_MAP = {
  'DM me': 'Send me a DM and I\u2019ll get back to you today.',
  'Comment QUOTE': 'Comment QUOTE below and I\u2019ll reach out with details.',
  'Text me': 'Text me anytime \u2014 happy to answer questions.',
  'Call or text': 'Feel free to call or text. I\u2019m easy to reach.',
  'Drop a comment': 'Drop a comment below if you\u2019re interested or have questions.',
};

function getSeason() {
  const m = new Date().getMonth();
  if (m >= 2 && m <= 4) return 'Spring';
  if (m >= 5 && m <= 7) return 'Summer';
  if (m >= 8 && m <= 10) return 'Fall';
  return 'Winter';
}

function buildContext(inputs) {
  const p = S.profile;
  const isGSO = inputs.market === 'Greensboro';
  const areas = isGSO ? p.serviceAreasGSO : p.serviceAreasTRI;
  const area = areas.length ? areas[Math.floor(Math.random()*areas.length)] : inputs.market;
  const proofParts = [];
  if (p.proofPoints.localOwner) proofParts.push('I\'m a local owner-operator');
  if (p.proofPoints.insured) proofParts.push('fully insured');
  if (p.proofPoints.carefulPlants) proofParts.push('careful around your landscaping');
  if (p.proofPoints.beforeAfter) proofParts.push('before & after photos available');
  if (p.proofPoints.yearsExperience) proofParts.push('years of experience');
  if (p.proofPoints.googleReviews) proofParts.push('Google reviews to back it up');

  let proofLine = '';
  if (proofParts.length >= 2) {
    proofLine = proofParts[0].charAt(0).toUpperCase() + proofParts[0].slice(1) + ', ' + proofParts.slice(1,3).join(', and ') + '.';
  } else if (proofParts.length === 1) {
    proofLine = proofParts[0].charAt(0).toUpperCase() + proofParts[0].slice(1) + '.';
  }

  return {
    market: inputs.market,
    area,
    service: inputs.service,
    serviceLower: inputs.service.toLowerCase(),
    season: getSeason(),
    proofLine,
    ownerLine: p.proofPoints.localOwner ? 'I\'m a local owner-operator here in ' + inputs.market + '.' : '',
    tone: p.tone,
    cta: CTA_MAP[inputs.cta] || inputs.cta,
    offerStyle: inputs.offerStyle,
    hookAngle: inputs.hookAngle,
    photoLabel: inputs.photoLabel,
    notes: inputs.notes,
    preferredPhrases: p.preferredPhrases,
    bannedWords: p.bannedWords,
  };
}

function generateVariations(inputs) {
  const ctx = buildContext(inputs);
  const hookTemplates = HOOKS[ctx.hookAngle] || HOOKS['Trust/Proof'];
  const offerLine = (OFFER_LINES[ctx.offerStyle] || OFFER_LINES['Ballpark from photo'])(ctx);
  const variations = [];

  for (let i = 0; i < 3; i++) {
    const hook = hookTemplates[i % hookTemplates.length](ctx);
    const preferred = ctx.preferredPhrases.length ? ctx.preferredPhrases[Math.floor(Math.random()*ctx.preferredPhrases.length)] : '';

    let longPost = hook + '\n\n' + offerLine;
    if (preferred && i < 2) longPost += ' ' + (preferred.charAt(0).toUpperCase() + preferred.slice(1)) + '.';
    if (ctx.photoLabel) longPost += '\n\n(Photo: ' + ctx.photoLabel + ')';
    longPost += '\n\n' + ctx.cta;
    if (ctx.notes && i === 0) longPost += '\n\n' + ctx.notes;

    // Short version: hook + cta
    let shortPost = hook + '\n\n' + ctx.cta;

    // Clean banned words
    ctx.bannedWords.forEach(bw => {
      const re = new RegExp(escapeRegex(bw), 'gi');
      longPost = longPost.replace(re, '');
      shortPost = shortPost.replace(re, '');
    });

    // Clean double spaces
    longPost = longPost.replace(/ {2,}/g,' ').trim();
    shortPost = shortPost.replace(/ {2,}/g,' ').trim();

    variations.push({
      label: String.fromCharCode(65+i),
      long: longPost,
      short: shortPost,
    });
  }

  // Reply scripts
  const replies = {
    price: `Happy to give you a number! Can you send me a photo of the ${ctx.serviceLower} and roughly how big the area is? I'll get you a quote today.`,
    availability: `I have availability this week. Want me to pencil you in? Just let me know what day works best.`,
    skepticism: `Totally fair question. ${ctx.proofLine || 'I\'m a local operator, fully insured.'} Happy to share before & after photos from recent jobs in ${ctx.area} if that helps.`,
    guttersToo: `Absolutely \u2014 I do gutters, house washes, driveways, roofs, and fences. If you want to bundle a couple services I can work with you on pricing.`,
  };

  return { variations, replies };
}

function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

/* ==========================================================================
   SCORING FUNCTIONS
   ========================================================================== */
function leadScore(r) {
  if (!r) return 0;
  return (r.jobsBooked||0)*10 + (r.quoteRequests||0)*4 + (r.dms||0)*2 + (r.calls||0)*2;
}
function engagementScore(r) {
  if (!r) return 0;
  return (r.comments||0)*3 + (r.reactions||0) + Math.floor((r.views||0)/100);
}

/* ==========================================================================
   RENDER: BUILDER
   ========================================================================== */
function renderBuilder(container) {
  const p = S.profile;
  container.innerHTML = `
    <div class="card">
      <div class="card-title">New Post <span class="badge">${getSeason()}</span></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Market</label>
          <select id="bMarket"><option>Greensboro</option><option>Triangle</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Platform</label>
          <select id="bPlatform"><option>Nextdoor</option><option>Facebook</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Post Type</label>
          <select id="bType"><option>CONTROL</option><option>TEST</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Service Focus</label>
          <select id="bService"><option>Driveway</option><option>House Wash</option><option>Gutters</option><option>Roof</option><option>Fence</option><option>Other</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Offer Style</label>
          <select id="bOffer"><option>Ballpark from photo</option><option>Bundle</option><option>Starting-at</option><option>Seasonal reminder</option><option>Availability</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Hook Angle</label>
          <select id="bHook"><option>Trust/Proof</option><option>Seasonal problem</option><option>Convenience</option><option>Outcome</option></select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">CTA</label>
        <select id="bCta">${p.ctaStyles.map(c=>'<option>'+esc(c)+'</option>').join('')}</select>
      </div>
      <div class="form-group">
        <label class="form-label">Photo Label</label>
        <input id="bPhoto" placeholder="e.g. Driveway BA Set 12">
      </div>
      <div class="form-group">
        <label class="form-label">Notes / Context</label>
        <textarea id="bNotes" rows="2" placeholder="Anything about the job, photo, or context..."></textarea>
      </div>
      <button class="btn btn-primary btn-block" id="bGenerate">Generate Variations</button>
    </div>
    <div id="bOutput"></div>
  `;

  document.getElementById('bGenerate').addEventListener('click', () => {
    const inputs = {
      market: document.getElementById('bMarket').value,
      platform: document.getElementById('bPlatform').value,
      postType: document.getElementById('bType').value,
      service: document.getElementById('bService').value,
      offerStyle: document.getElementById('bOffer').value,
      hookAngle: document.getElementById('bHook').value,
      cta: document.getElementById('bCta').value,
      photoLabel: document.getElementById('bPhoto').value,
      notes: document.getElementById('bNotes').value,
    };
    const { variations, replies } = generateVariations(inputs);
    renderBuilderOutput(inputs, variations, replies);
  });
}

function renderBuilderOutput(inputs, variations, replies) {
  const out = document.getElementById('bOutput');
  let html = '';
  variations.forEach(v => {
    html += `
      <div class="card">
        <div class="card-title">Variation ${v.label}</div>
        <div class="output-label">Long Version</div>
        <div class="output-box" id="long${v.label}">${esc(v.long)}<button class="copy-btn" onclick="copyText('long${v.label}')">Copy</button></div>
        <div class="output-label">Short Version</div>
        <div class="output-box" id="short${v.label}">${esc(v.short)}<button class="copy-btn" onclick="copyText('short${v.label}')">Copy</button></div>
        <div class="btn-group" style="margin-top:10px">
          <button class="btn btn-secondary btn-sm" onclick="saveDraft('${v.label}','long')">Save Long</button>
          <button class="btn btn-secondary btn-sm" onclick="saveDraft('${v.label}','short')">Save Short</button>
          <button class="btn btn-success btn-sm" onclick="markPosted('${v.label}','long')">Post Long</button>
          <button class="btn btn-success btn-sm" onclick="markPosted('${v.label}','short')">Post Short</button>
        </div>
      </div>`;
  });
  // Reply scripts
  html += `<div class="card"><div class="card-title">Reply Scripts</div>`;
  const replyLabels = {price:'Price inquiry',availability:'Availability',skepticism:'Skepticism',guttersToo:'Can you do gutters too?'};
  Object.keys(replies).forEach(k => {
    html += `<div class="output-label">${replyLabels[k]}</div><div class="output-box" id="reply_${k}">${esc(replies[k])}<button class="copy-btn" onclick="copyText('reply_${k}')">Copy</button></div>`;
  });
  html += '</div>';
  out.innerHTML = html;

  // Store temp data for save/post actions
  window._builderInputs = inputs;
  window._builderVariations = variations;
  window._builderReplies = replies;
}

window.copyText = function(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.innerText.replace('Copy','').trim();
  navigator.clipboard.writeText(text).then(()=>toast('Copied')).catch(()=>{
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta); toast('Copied');
  });
};

window.saveDraft = function(varLabel, version) {
  const v = window._builderVariations.find(x=>x.label===varLabel);
  const inp = window._builderInputs;
  if (!v || !inp) return;
  const post = {
    id: S.nextId++,
    market: inp.market,
    platform: inp.platform,
    postType: inp.postType,
    service: inp.service,
    offerStyle: inp.offerStyle,
    hookAngle: inp.hookAngle,
    cta: inp.cta,
    tone: S.profile.tone,
    photoLabel: inp.photoLabel,
    notes: inp.notes,
    variation: varLabel,
    version: version,
    content: version === 'long' ? v.long : v.short,
    allVariations: window._builderVariations,
    replies: window._builderReplies,
    status: 'draft',
    createdAt: new Date().toISOString(),
    postedAt: null,
  };
  S.posts.push(post);
  saveState();
  toast('Draft saved');
};

window.markPosted = function(varLabel, version) {
  const v = window._builderVariations.find(x=>x.label===varLabel);
  const inp = window._builderInputs;
  if (!v || !inp) return;
  const post = {
    id: S.nextId++,
    market: inp.market,
    platform: inp.platform,
    postType: inp.postType,
    service: inp.service,
    offerStyle: inp.offerStyle,
    hookAngle: inp.hookAngle,
    cta: inp.cta,
    tone: S.profile.tone,
    photoLabel: inp.photoLabel,
    notes: inp.notes,
    variation: varLabel,
    version: version,
    content: version === 'long' ? v.long : v.short,
    allVariations: window._builderVariations,
    replies: window._builderReplies,
    status: 'posted',
    createdAt: new Date().toISOString(),
    postedAt: new Date().toISOString(),
  };
  S.posts.push(post);
  saveState();
  toast('Marked as posted');
};

/* ==========================================================================
   RENDER: LIBRARY
   ========================================================================== */
function renderLibrary(container) {
  let html = `<div class="filter-bar">
    <select id="fMarket"><option value="">All Markets</option><option>Greensboro</option><option>Triangle</option></select>
    <select id="fType"><option value="">All Types</option><option>CONTROL</option><option>TEST</option></select>
    <select id="fService"><option value="">All Services</option><option>Driveway</option><option>House Wash</option><option>Gutters</option><option>Roof</option><option>Fence</option><option>Other</option></select>
    <select id="fStatus"><option value="">All Status</option><option>draft</option><option>posted</option></select>
    <select id="fPlatform"><option value="">All Platforms</option><option>Nextdoor</option><option>Facebook</option></select>
  </div><div id="libList"></div>`;
  container.innerHTML = html;

  function filterAndRender() {
    const fm = document.getElementById('fMarket').value;
    const ft = document.getElementById('fType').value;
    const fs = document.getElementById('fService').value;
    const fst = document.getElementById('fStatus').value;
    const fp = document.getElementById('fPlatform').value;
    let posts = S.posts.slice().reverse();
    if (fm) posts = posts.filter(p=>p.market===fm);
    if (ft) posts = posts.filter(p=>p.postType===ft);
    if (fs) posts = posts.filter(p=>p.service===fs);
    if (fst) posts = posts.filter(p=>p.status===fst);
    if (fp) posts = posts.filter(p=>p.platform===fp);

    if (posts.length === 0) {
      document.getElementById('libList').innerHTML = `<div class="empty-state"><p>No posts yet. Go build something.</p></div>`;
      return;
    }
    document.getElementById('libList').innerHTML = posts.map(p => `
      <div class="post-card" onclick="openPostDetail(${p.id})">
        <div class="post-card-header">
          <div class="post-card-title">${esc(p.service)} \u2014 ${esc(p.market)}</div>
          <span class="tag ${p.status==='posted'?'green':'blue'}">${p.status}</span>
        </div>
        <div class="post-card-preview">${esc(p.content)}</div>
        <div class="post-card-meta">
          <span class="tag">${esc(p.postType)}</span>
          <span class="tag">${esc(p.platform)}</span>
          <span class="tag">${esc(p.offerStyle)}</span>
          <span class="tag">${esc(p.hookAngle)}</span>
          <span style="margin-left:auto;font-size:.68rem;color:var(--text-muted)">${formatDate(p.createdAt)}</span>
        </div>
      </div>
    `).join('');
  }

  ['fMarket','fType','fService','fStatus','fPlatform'].forEach(id => {
    document.getElementById(id).addEventListener('change', filterAndRender);
  });
  filterAndRender();
}

window.openPostDetail = function(id) {
  const p = S.posts.find(x=>x.id===id);
  if (!p) return;
  let html = `
    <div class="modal-header"><h3>${esc(p.service)} \u2014 ${esc(p.market)}</h3><button class="modal-close" onclick="closeModal()">\u00d7</button></div>
    <div class="form-group"><div class="form-label">Status</div><span class="tag ${p.status==='posted'?'green':'blue'}">${p.status}</span></div>
    <div class="form-group"><div class="form-label">Platform / Type / Tone</div><div>${esc(p.platform)} \u2022 ${esc(p.postType)} \u2022 ${esc(p.tone||'Friendly')}</div></div>
    <div class="form-group"><div class="form-label">Offer / Hook / CTA</div><div>${esc(p.offerStyle)} \u2022 ${esc(p.hookAngle)} \u2022 ${esc(p.cta)}</div></div>
    ${p.photoLabel ? `<div class="form-group"><div class="form-label">Photo</div><div>${esc(p.photoLabel)}</div></div>` : ''}
    ${p.notes ? `<div class="form-group"><div class="form-label">Notes</div><div style="font-size:.84rem;color:var(--text-dim)">${esc(p.notes)}</div></div>` : ''}
    <hr class="divider">
    <div class="output-label">Content (Variation ${esc(p.variation)} / ${esc(p.version)})</div>
    <div class="output-box" id="modalContent">${esc(p.content)}<button class="copy-btn" onclick="copyText('modalContent')">Copy</button></div>
    <div class="form-group"><div class="form-label">Created</div><div>${formatDateTime(p.createdAt)}</div></div>
    ${p.postedAt ? `<div class="form-group"><div class="form-label">Posted</div><div>${formatDateTime(p.postedAt)}</div></div>` : ''}
    <hr class="divider">
    <div class="btn-group">
      ${p.status==='draft' ? `<button class="btn btn-success btn-sm" onclick="postFromLib(${id})">Mark Posted</button>` : ''}
      <button class="btn btn-secondary btn-sm" onclick="duplicatePost(${id})">Duplicate</button>
      <button class="btn btn-danger btn-sm" onclick="deletePost(${id})">Delete</button>
    </div>
  `;
  openModal(html);
};

window.postFromLib = function(id) {
  const p = S.posts.find(x=>x.id===id);
  if (p) { p.status = 'posted'; p.postedAt = new Date().toISOString(); saveState(); closeModal(); render(); toast('Marked as posted'); }
};
window.duplicatePost = function(id) {
  const p = S.posts.find(x=>x.id===id);
  if (p) { const dup = JSON.parse(JSON.stringify(p)); dup.id = S.nextId++; dup.status = 'draft'; dup.createdAt = new Date().toISOString(); dup.postedAt = null; S.posts.push(dup); saveState(); closeModal(); render(); toast('Post duplicated'); }
};
window.deletePost = function(id) {
  if (confirm('Delete this post?')) {
    S.posts = S.posts.filter(x=>x.id!==id);
    delete S.results[id];
    saveState(); closeModal(); render(); toast('Post deleted');
  }
};

/* ==========================================================================
   RENDER: RESULTS
   ========================================================================== */
function renderResults(container) {
  const posted = S.posts.filter(p=>p.status==='posted').reverse();
  if (posted.length === 0) {
    container.innerHTML = `<div class="empty-state"><p>No posted entries yet. Post something from the Builder or Library first.</p></div>`;
    return;
  }
  let html = `<div class="card"><div class="card-title">Log Results</div><p style="font-size:.8rem;color:var(--text-muted);margin-bottom:12px">Select a posted entry to log its performance metrics.</p>`;
  html += posted.map(p => {
    const r = S.results[p.id];
    const ls = leadScore(r);
    return `<div class="post-card" onclick="openResultsEntry(${p.id})">
      <div class="post-card-header">
        <div class="post-card-title">${esc(p.service)} \u2014 ${esc(p.market)}</div>
        <span class="tag ${ls > 0 ? 'green':'blue'}">${ls > 0 ? 'Lead: '+ls : 'No data'}</span>
      </div>
      <div class="post-card-preview">${esc(p.content.slice(0,100))}</div>
      <div class="post-card-meta">
        <span class="tag">${esc(p.postType)}</span>
        <span class="tag">${esc(p.platform)}</span>
        <span style="margin-left:auto;font-size:.68rem;color:var(--text-muted)">Posted ${formatDate(p.postedAt)}</span>
      </div>
    </div>`;
  }).join('');
  html += '</div>';
  container.innerHTML = html;
}

window.openResultsEntry = function(id) {
  const p = S.posts.find(x=>x.id===id);
  if (!p) return;
  const r = S.results[id] || {};
  const reminders = r.reminders || {h24:false,h72:false,d7:false};

  let html = `
    <div class="modal-header"><h3>Results: ${esc(p.service)} \u2014 ${esc(p.market)}</h3><button class="modal-close" onclick="closeModal()">\u00d7</button></div>
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:12px">${esc(p.postType)} \u2022 ${esc(p.platform)} \u2022 Posted ${formatDate(p.postedAt)}</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Views</label><input type="number" id="rViews" value="${r.views||0}" min="0"></div>
      <div class="form-group"><label class="form-label">Reactions</label><input type="number" id="rReactions" value="${r.reactions||0}" min="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Comments</label><input type="number" id="rComments" value="${r.comments||0}" min="0"></div>
      <div class="form-group"><label class="form-label">DMs / Messages</label><input type="number" id="rDms" value="${r.dms||0}" min="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Calls / Texts</label><input type="number" id="rCalls" value="${r.calls||0}" min="0"></div>
      <div class="form-group"><label class="form-label">Quote Requests</label><input type="number" id="rQuotes" value="${r.quoteRequests||0}" min="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Jobs Booked</label><input type="number" id="rJobs" value="${r.jobsBooked||0}" min="0"></div>
      <div class="form-group"><label class="form-label">Revenue ($)</label><input type="number" id="rRevenue" value="${r.revenue||0}" min="0" step="0.01"></div>
    </div>
    <div class="form-group"><label class="form-label">Notes (objections, questions, feedback)</label><textarea id="rNotes" rows="3">${esc(r.notes||'')}</textarea></div>
    <hr class="divider">
    <div class="form-label" style="margin-bottom:8px">Log Results Reminder Checklist</div>
    <div class="reminder-item"><div class="reminder-check${reminders.h24?' checked':''}" onclick="toggleReminder(this,'h24',${id})"></div><div>24-hour check-in</div></div>
    <div class="reminder-item"><div class="reminder-check${reminders.h72?' checked':''}" onclick="toggleReminder(this,'h72',${id})"></div><div>72-hour check-in</div></div>
    <div class="reminder-item"><div class="reminder-check${reminders.d7?' checked':''}" onclick="toggleReminder(this,'d7',${id})"></div><div>7-day final review</div></div>
    <hr class="divider">
    <button class="btn btn-primary btn-block" onclick="saveResults(${id})">Save Results</button>
  `;
  openModal(html);
};

window.toggleReminder = function(el, key, id) {
  el.classList.toggle('checked');
  if (!S.results[id]) S.results[id] = {};
  if (!S.results[id].reminders) S.results[id].reminders = {h24:false,h72:false,d7:false};
  S.results[id].reminders[key] = el.classList.contains('checked');
  saveState();
};

window.saveResults = function(id) {
  const existing = S.results[id] || {};
  S.results[id] = {
    views: parseInt(document.getElementById('rViews').value)||0,
    reactions: parseInt(document.getElementById('rReactions').value)||0,
    comments: parseInt(document.getElementById('rComments').value)||0,
    dms: parseInt(document.getElementById('rDms').value)||0,
    calls: parseInt(document.getElementById('rCalls').value)||0,
    quoteRequests: parseInt(document.getElementById('rQuotes').value)||0,
    jobsBooked: parseInt(document.getElementById('rJobs').value)||0,
    revenue: parseFloat(document.getElementById('rRevenue').value)||0,
    notes: document.getElementById('rNotes').value,
    reminders: existing.reminders || {h24:false,h72:false,d7:false},
  };
  saveState();
  closeModal();
  render();
  toast('Results saved');
};

/* ==========================================================================
   RENDER: DASHBOARD
   ========================================================================== */
function renderDashboard(container) {
  const posted = S.posts.filter(p=>p.status==='posted');
  if (posted.length === 0) {
    container.innerHTML = `<div class="empty-state"><p>No data yet. Post and log results to see analytics.</p></div>`;
    return;
  }

  // Compute scores for each posted post
  const scored = posted.map(p => {
    const r = S.results[p.id];
    return { ...p, result: r, ls: leadScore(r), es: engagementScore(r) };
  });

  // Totals
  const totalLeads = scored.reduce((s,x)=>s+x.ls,0);
  const totalEng = scored.reduce((s,x)=>s+x.es,0);
  const totalJobs = scored.reduce((s,x)=>s+(x.result?.jobsBooked||0),0);
  const totalRevenue = scored.reduce((s,x)=>s+(x.result?.revenue||0),0);

  // Top posts
  const topByLead = scored.slice().sort((a,b)=>b.ls-a.ls).slice(0,5);
  const topByEng = scored.slice().sort((a,b)=>b.es-a.es).slice(0,5);

  // By market
  const gso = scored.filter(p=>p.market==='Greensboro');
  const tri = scored.filter(p=>p.market==='Triangle');
  const avgLS = arr => arr.length ? Math.round(arr.reduce((s,x)=>s+x.ls,0)/arr.length) : 0;

  // Pattern analysis
  function bestBy(key) {
    const groups = {};
    scored.forEach(p => {
      const k = p[key] || 'Unknown';
      if (!groups[k]) groups[k] = [];
      groups[k].push(p.ls);
    });
    let best = '', bestAvg = -1;
    Object.keys(groups).forEach(k => {
      const avg = groups[k].reduce((a,b)=>a+b,0) / groups[k].length;
      if (avg > bestAvg) { bestAvg = avg; best = k; }
    });
    return { name: best, avg: Math.round(bestAvg), count: groups[best]?.length || 0 };
  }

  const bestService = bestBy('service');
  const bestOffer = bestBy('offerStyle');
  const bestHook = bestBy('hookAngle');
  const bestCta = bestBy('cta');

  // Winning formula per market
  function winningFormula(posts) {
    if (posts.length === 0) return null;
    const top = posts.slice().sort((a,b)=>b.ls-a.ls)[0];
    return top ? { service: top.service, offerStyle: top.offerStyle, hookAngle: top.hookAngle, cta: top.cta, ls: top.ls } : null;
  }
  const winGSO = winningFormula(gso);
  const winTRI = winningFormula(tri);

  let html = `
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-value">${posted.length}</div><div class="stat-label">Posts</div></div>
      <div class="stat-card"><div class="stat-value">${totalJobs}</div><div class="stat-label">Jobs Booked</div></div>
      <div class="stat-card"><div class="stat-value">${totalLeads}</div><div class="stat-label">Lead Score</div></div>
      <div class="stat-card"><div class="stat-value">$${totalRevenue.toLocaleString()}</div><div class="stat-label">Revenue</div></div>
    </div>
  `;

  // Market comparison
  html += `<div class="card" style="margin-top:14px">
    <div class="card-title">Market Comparison</div>
    <div class="form-row">
      <div class="stat-card"><div class="stat-value">${avgLS(gso)}</div><div class="stat-label">Greensboro Avg LS</div></div>
      <div class="stat-card"><div class="stat-value">${avgLS(tri)}</div><div class="stat-label">Triangle Avg LS</div></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="stat-card"><div class="stat-value">${gso.length}</div><div class="stat-label">GSO Posts</div></div>
      <div class="stat-card"><div class="stat-value">${tri.length}</div><div class="stat-label">TRI Posts</div></div>
    </div>
  </div>`;

  // Winning Formulas
  html += `<div class="card"><div class="card-title">Winning Formulas</div>`;
  if (winGSO) {
    html += `<div class="winning-box"><h4>Greensboro</h4>
      <div class="winning-item"><strong>Service:</strong> ${esc(winGSO.service)}</div>
      <div class="winning-item"><strong>Offer:</strong> ${esc(winGSO.offerStyle)}</div>
      <div class="winning-item"><strong>Hook:</strong> ${esc(winGSO.hookAngle)}</div>
      <div class="winning-item"><strong>CTA:</strong> ${esc(winGSO.cta)}</div>
      <div class="winning-item"><strong>Lead Score:</strong> ${winGSO.ls}</div>
    </div>`;
  } else {
    html += `<div style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">No Greensboro data yet.</div>`;
  }
  if (winTRI) {
    html += `<div class="winning-box"><h4>Triangle</h4>
      <div class="winning-item"><strong>Service:</strong> ${esc(winTRI.service)}</div>
      <div class="winning-item"><strong>Offer:</strong> ${esc(winTRI.offerStyle)}</div>
      <div class="winning-item"><strong>Hook:</strong> ${esc(winTRI.hookAngle)}</div>
      <div class="winning-item"><strong>CTA:</strong> ${esc(winTRI.cta)}</div>
      <div class="winning-item"><strong>Lead Score:</strong> ${winTRI.ls}</div>
    </div>`;
  } else {
    html += `<div style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">No Triangle data yet.</div>`;
  }
  html += `</div>`;

  // Pattern summary
  html += `<div class="card"><div class="card-title">Best Performers by Pattern</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="stat-card"><div class="stat-value" style="font-size:1rem">${esc(bestService.name)}</div><div class="stat-label">Best Service (avg ${bestService.avg})</div></div>
      <div class="stat-card"><div class="stat-value" style="font-size:1rem">${esc(bestOffer.name)}</div><div class="stat-label">Best Offer (avg ${bestOffer.avg})</div></div>
      <div class="stat-card"><div class="stat-value" style="font-size:1rem">${esc(bestHook.name)}</div><div class="stat-label">Best Hook (avg ${bestHook.avg})</div></div>
      <div class="stat-card"><div class="stat-value" style="font-size:1rem">${esc(bestCta.name)}</div><div class="stat-label">Best CTA (avg ${bestCta.avg})</div></div>
    </div>
  </div>`;

  // Top posts by lead score
  html += `<div class="card"><div class="card-title">Top Posts by Lead Score</div>`;
  if (topByLead.length) {
    topByLead.forEach((p, i) => {
      html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;${i<topByLead.length-1?'border-bottom:1px solid var(--border)':''}">
        <div style="font-size:1.1rem;font-weight:700;color:var(--accent);width:28px;text-align:center">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.82rem;font-weight:500">${esc(p.service)} \u2014 ${esc(p.market)}</div>
          <div style="font-size:.72rem;color:var(--text-muted)">${esc(p.postType)} \u2022 ${esc(p.offerStyle)} \u2022 ${esc(p.hookAngle)}</div>
        </div>
        <div><span class="tag green">LS ${p.ls}</span></div>
      </div>`;
    });
  }
  html += '</div>';

  // Top posts by engagement
  html += `<div class="card"><div class="card-title">Top Posts by Engagement</div>`;
  if (topByEng.length) {
    topByEng.forEach((p, i) => {
      html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;${i<topByEng.length-1?'border-bottom:1px solid var(--border)':''}">
        <div style="font-size:1.1rem;font-weight:700;color:var(--accent);width:28px;text-align:center">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.82rem;font-weight:500">${esc(p.service)} \u2014 ${esc(p.market)}</div>
          <div style="font-size:.72rem;color:var(--text-muted)">${esc(p.postType)} \u2022 ${esc(p.hookAngle)}</div>
        </div>
        <div><span class="tag blue">ES ${p.es}</span></div>
      </div>`;
    });
  }
  html += '</div>';

  container.innerHTML = html;
}

/* ==========================================================================
   RENDER: SETTINGS
   ========================================================================== */
function renderSettings(container) {
  const p = S.profile;
  let html = `
    <div class="card">
      <div class="card-title">Brand Voice Profile</div>
      <div class="form-group">
        <label class="form-label">Tone Preset</label>
        <div class="chip-group" id="sToneChips">
          ${['Neutral','Friendly','Direct','Premium'].map(t=>`<div class="chip${p.tone===t?' active':''}" data-tone="${t}">${t}</div>`).join('')}
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Banned Words / Phrases</label>
        <textarea id="sBanned" rows="3" placeholder="One per line">${p.bannedWords.join('\n')}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Preferred Phrases</label>
        <textarea id="sPreferred" rows="3" placeholder="One per line">${p.preferredPhrases.join('\n')}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">CTA Styles</label>
        <textarea id="sCtas" rows="2" placeholder="One per line">${p.ctaStyles.join('\n')}</textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Proof Points</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${Object.keys(p.proofPoints).map(k => `
          <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;cursor:pointer;padding:6px 0">
            <input type="checkbox" class="proof-toggle" data-key="${k}" ${p.proofPoints[k]?'checked':''}
              style="width:18px;height:18px;accent-color:var(--accent)">
            ${proofLabel(k)}
          </label>
        `).join('')}
      </div>
    </div>

    <div class="card">
      <div class="card-title">Service Areas \u2014 Greensboro</div>
      <div class="form-group">
        <textarea id="sAreasGSO" rows="3" placeholder="One neighborhood per line">${p.serviceAreasGSO.join('\n')}</textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Service Areas \u2014 Triangle</div>
      <div class="form-group">
        <textarea id="sAreasTRI" rows="3" placeholder="One neighborhood per line">${p.serviceAreasTRI.join('\n')}</textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Data Management</div>
      <div class="btn-group" style="flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" onclick="exportData()">Export JSON</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()">Import JSON</button>
        <button class="btn btn-danger btn-sm" onclick="resetAllData()">Reset All Data</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display:none">
    </div>

    <button class="btn btn-primary btn-block" id="sSave" style="margin-top:4px">Save Settings</button>
  `;
  container.innerHTML = html;

  // Tone chips
  document.querySelectorAll('#sToneChips .chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('#sToneChips .chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });
  });

  // Import handler
  document.getElementById('importFile').addEventListener('change', function(e) {
    if (e.target.files[0]) importData(e.target.files[0]);
  });

  // Save
  document.getElementById('sSave').addEventListener('click', () => {
    const activeChip = document.querySelector('#sToneChips .chip.active');
    S.profile.tone = activeChip ? activeChip.dataset.tone : 'Friendly';
    S.profile.bannedWords = textToArr(document.getElementById('sBanned').value);
    S.profile.preferredPhrases = textToArr(document.getElementById('sPreferred').value);
    S.profile.ctaStyles = textToArr(document.getElementById('sCtas').value);
    S.profile.serviceAreasGSO = textToArr(document.getElementById('sAreasGSO').value);
    S.profile.serviceAreasTRI = textToArr(document.getElementById('sAreasTRI').value);
    document.querySelectorAll('.proof-toggle').forEach(cb => {
      S.profile.proofPoints[cb.dataset.key] = cb.checked;
    });
    saveState();
    toast('Settings saved');
  });
}

window.resetAllData = function() {
  if (confirm('This will erase all posts, results, and settings. Are you sure?')) {
    if (confirm('Last chance \u2014 this cannot be undone. Continue?')) {
      S = JSON.parse(JSON.stringify(DEFAULT_STATE));
      saveState();
      render();
      toast('All data reset');
    }
  }
};

function proofLabel(key) {
  const labels = {
    localOwner:'Local owner-operator',insured:'Fully insured',carefulPlants:'Careful around plants',
    beforeAfter:'Before & after available',neighborhoodFocus:'Neighborhood focus',
    yearsExperience:'Years of experience',googleReviews:'Google reviews',
  };
  return labels[key] || key;
}

/* ==========================================================================
   UTILITIES
   ========================================================================== */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function textToArr(s) {
  return s.split('\n').map(x=>x.trim()).filter(Boolean);
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

function formatDateTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) + ' at ' +
    d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
}

/* ==========================================================================
   INIT
   ========================================================================== */
render();
</script>
</body>
</html>
